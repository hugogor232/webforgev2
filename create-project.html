<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nouveau Projet - WebForge AI</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Wizard Specific Styles */
        body {
            background-color: var(--bg-dark);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .wizard-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border-color);
            background: var(--card-bg);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .wizard-container {
            flex: 1;
            max-width: 800px;
            width: 100%;
            margin: 0 auto;
            padding: 2rem;
            display: flex;
            flex-direction: column;
        }

        /* Progress Bar */
        .progress-container {
            margin-bottom: 3rem;
            position: relative;
        }

        .progress-track {
            background: var(--border-color);
            height: 4px;
            width: 100%;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            z-index: 0;
            border-radius: 4px;
        }

        .progress-fill {
            background: var(--primary-color);
            height: 4px;
            width: 0%;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            z-index: 0;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .steps {
            display: flex;
            justify-content: space-between;
            position: relative;
            z-index: 1;
        }

        .step-indicator {
            width: 32px;
            height: 32px;
            background: var(--bg-dark);
            border: 2px solid var(--border-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-muted);
            transition: all 0.3s ease;
        }

        .step-indicator.active {
            border-color: var(--primary-color);
            color: var(--primary-color);
            background: var(--bg-dark);
        }

        .step-indicator.completed {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }

        /* Wizard Steps */
        .wizard-step {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .wizard-step.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .step-title {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: white;
        }

        .step-desc {
            color: var(--text-muted);
            margin-bottom: 2rem;
        }

        /* Selection Cards */
        .selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }

        .selection-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .selection-card:hover {
            border-color: var(--text-muted);
            transform: translateY(-2px);
        }

        .selection-card.selected {
            border-color: var(--primary-color);
            background: rgba(var(--primary-rgb), 0.05);
            box-shadow: 0 0 0 1px var(--primary-color);
        }

        .selection-icon {
            font-size: 2rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
        }

        .selection-card.selected .selection-icon {
            color: var(--primary-color);
        }

        .selection-card h3 {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .selection-card p {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        /* Checkbox Cards */
        .checkbox-card {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s;
        }

        .checkbox-card:hover {
            border-color: var(--text-muted);
        }

        .checkbox-card.selected {
            border-color: var(--primary-color);
            background: rgba(var(--primary-rgb), 0.05);
        }

        .custom-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .checkbox-card.selected .custom-checkbox {
            background: var(--primary-color);
            border-color: var(--primary-color);
        }

        .custom-checkbox i {
            color: white;
            font-size: 0.7rem;
            display: none;
        }

        .checkbox-card.selected .custom-checkbox i {
            display: block;
        }

        /* Navigation Buttons */
        .wizard-footer {
            margin-top: auto;
            padding-top: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .loader-content {
            max-width: 400px;
        }

        .ai-loader {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-left-color: var(--primary-color);
            animation: spin 1s linear infinite;
            margin: 0 auto 1.5rem;
        }

        .loading-steps {
            margin-top: 2rem;
            text-align: left;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .loading-step {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
            opacity: 0.5;
        }

        .loading-step.active {
            opacity: 1;
            color: white;
        }

        .loading-step.completed {
            opacity: 1;
            color: var(--success-color, #22c55e);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <header class="wizard-header">
        <a href="dashboard.html" class="logo">
            <i class="fa-solid fa-cube"></i> WebForge<span>AI</span>
        </a>
        <a href="dashboard.html" class="btn-text">
            <i class="fa-solid fa-times"></i> Annuler
        </a>
    </header>

    <div class="wizard-container">
        <!-- Progress Bar -->
        <div class="progress-container">
            <div class="progress-track"></div>
            <div class="progress-fill" id="progress-fill"></div>
            <div class="steps">
                <div class="step-indicator active" data-step="1">1</div>
                <div class="step-indicator" data-step="2">2</div>
                <div class="step-indicator" data-step="3">3</div>
                <div class="step-indicator" data-step="4">4</div>
                <div class="step-indicator" data-step="5">5</div>
            </div>
        </div>

        <form id="wizard-form">
            
            <!-- STEP 1: Informations -->
            <div class="wizard-step active" id="step-1">
                <h2 class="step-title">Commençons par les bases</h2>
                <p class="step-desc">Donnez un nom à votre projet et décrivez ce que vous souhaitez créer.</p>
                
                <div class="form-group">
                    <label for="project-name" class="form-label">Nom du projet</label>
                    <input type="text" id="project-name" class="form-input" placeholder="Ex: Mon Portfolio, Startup SaaS..." required>
                </div>

                <div class="form-group">
                    <label for="project-desc" class="form-label">Description (Prompt IA)</label>
                    <textarea id="project-desc" class="form-input" rows="6" placeholder="Décrivez votre site en détail : 'Une landing page pour une application de fitness avec un design sombre, une section de témoignages et un tableau de prix...'" required></textarea>
                    <p class="text-sm text-muted mt-2">Plus votre description est précise, meilleur sera le résultat.</p>
                </div>
            </div>

            <!-- STEP 2: Type de site -->
            <div class="wizard-step" id="step-2">
                <h2 class="step-title">Quel type de site voulez-vous ?</h2>
                <p class="step-desc">Cela aidera l'IA à structurer le contenu et la navigation.</p>
                
                <div class="selection-grid">
                    <div class="selection-card" onclick="selectOption('type', 'landing')">
                        <div class="selection-icon"><i class="fa-solid fa-rocket"></i></div>
                        <h3>Landing Page</h3>
                        <p>Une page unique optimisée pour la conversion.</p>
                    </div>
                    <div class="selection-card" onclick="selectOption('type', 'portfolio')">
                        <div class="selection-icon"><i class="fa-solid fa-camera"></i></div>
                        <h3>Portfolio</h3>
                        <p>Présentez vos travaux et votre CV.</p>
                    </div>
                    <div class="selection-card" onclick="selectOption('type', 'saas')">
                        <div class="selection-icon"><i class="fa-solid fa-layer-group"></i></div>
                        <h3>SaaS / App</h3>
                        <p>Interface moderne pour application web.</p>
                    </div>
                    <div class="selection-card" onclick="selectOption('type', 'ecommerce')">
                        <div class="selection-icon"><i class="fa-solid fa-store"></i></div>
                        <h3>E-commerce</h3>
                        <p>Boutique en ligne avec produits.</p>
                    </div>
                    <div class="selection-card" onclick="selectOption('type', 'blog')">
                        <div class="selection-icon"><i class="fa-solid fa-pen-nib"></i></div>
                        <h3>Blog</h3>
                        <p>Articles, catégories et contenu éditorial.</p>
                    </div>
                </div>
                <input type="hidden" id="selected-type" required>
            </div>

            <!-- STEP 3: Style Visuel -->
            <div class="wizard-step" id="step-3">
                <h2 class="step-title">Choisissez une ambiance visuelle</h2>
                <p class="step-desc">Définissez l'esthétique générale de votre site.</p>
                
                <div class="selection-grid">
                    <div class="selection-card" onclick="selectOption('style', 'minimal')">
                        <div class="selection-icon"><i class="fa-regular fa-square"></i></div>
                        <h3>Minimaliste</h3>
                        <p>Épuré, beaucoup d'espace blanc, typographie simple.</p>
                    </div>
                    <div class="selection-card" onclick="selectOption('style', 'dark')">
                        <div class="selection-icon"><i class="fa-solid fa-moon"></i></div>
                        <h3>Dark Mode</h3>
                        <p>Moderne, élégant, contrastes forts sur fond sombre.</p>
                    </div>
                    <div class="selection-card" onclick="selectOption('style', 'corporate')">
                        <div class="selection-icon"><i class="fa-solid fa-building"></i></div>
                        <h3>Corporate</h3>
                        <p>Professionnel, bleu/gris, rassurant et sérieux.</p>
                    </div>
                    <div class="selection-card" onclick="selectOption('style', 'playful')">
                        <div class="selection-icon"><i class="fa-solid fa-shapes"></i></div>
                        <h3>Créatif</h3>
                        <p>Couleurs vives, formes organiques, typographie audacieuse.</p>
                    </div>
                </div>
                <input type="hidden" id="selected-style" required>
            </div>

            <!-- STEP 4: Fonctionnalités -->
            <div class="wizard-step" id="step-4">
                <h2 class="step-title">Fonctionnalités requises</h2>
                <p class="step-desc">Sélectionnez les composants techniques à intégrer.</p>
                
                <div class="selection-grid">
                    <div class="checkbox-card" onclick="toggleCheckbox(this, 'contact_form')">
                        <div class="custom-checkbox"><i class="fa-solid fa-check"></i></div>
                        <div>
                            <h3>Formulaire de contact</h3>
                            <p>Envoi d'emails via API.</p>
                        </div>
                    </div>
                    <div class="checkbox-card" onclick="toggleCheckbox(this, 'newsletter')">
                        <div class="custom-checkbox"><i class="fa-solid fa-check"></i></div>
                        <div>
                            <h3>Newsletter</h3>
                            <p>Capture d'emails visiteurs.</p>
                        </div>
                    </div>
                    <div class="checkbox-card" onclick="toggleCheckbox(this, 'auth')">
                        <div class="custom-checkbox"><i class="fa-solid fa-check"></i></div>
                        <div>
                            <h3>Authentification</h3>
                            <p>Login/Register (Supabase).</p>
                        </div>
                    </div>
                    <div class="checkbox-card" onclick="toggleCheckbox(this, 'database')">
                        <div class="custom-checkbox"><i class="fa-solid fa-check"></i></div>
                        <div>
                            <h3>Base de données</h3>
                            <p>Connexion CRUD dynamique.</p>
                        </div>
                    </div>
                    <div class="checkbox-card" onclick="toggleCheckbox(this, 'dark_mode_toggle')">
                        <div class="custom-checkbox"><i class="fa-solid fa-check"></i></div>
                        <div>
                            <h3>Toggle Dark Mode</h3>
                            <p>Bouton jour/nuit.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- STEP 5: Pages -->
            <div class="wizard-step" id="step-5">
                <h2 class="step-title">Structure du site</h2>
                <p class="step-desc">Quelles pages souhaitez-vous générer ?</p>
                
                <div class="selection-grid">
                    <div class="checkbox-card selected" onclick="toggleCheckbox(this, 'page_home')">
                        <div class="custom-checkbox"><i class="fa-solid fa-check"></i></div>
                        <div>
                            <h3>Accueil</h3>
                            <p>La vitrine principale (Obligatoire).</p>
                        </div>
                    </div>
                    <div class="checkbox-card" onclick="toggleCheckbox(this, 'page_about')">
                        <div class="custom-checkbox"><i class="fa-solid fa-check"></i></div>
                        <div>
                            <h3>À propos</h3>
                            <p>Histoire, équipe, mission.</p>
                        </div>
                    </div>
                    <div class="checkbox-card" onclick="toggleCheckbox(this, 'page_contact')">
                        <div class="custom-checkbox"><i class="fa-solid fa-check"></i></div>
                        <div>
                            <h3>Contact</h3>
                            <p>Formulaire et infos.</p>
                        </div>
                    </div>
                    <div class="checkbox-card" onclick="toggleCheckbox(this, 'page_pricing')">
                        <div class="custom-checkbox"><i class="fa-solid fa-check"></i></div>
                        <div>
                            <h3>Tarifs</h3>
                            <p>Tableaux de prix et FAQ.</p>
                        </div>
                    </div>
                    <div class="checkbox-card" onclick="toggleCheckbox(this, 'page_blog')">
                        <div class="custom-checkbox"><i class="fa-solid fa-check"></i></div>
                        <div>
                            <h3>Blog / Actu</h3>
                            <p>Liste d'articles.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="wizard-footer">
                <button type="button" id="prev-btn" class="btn-secondary" style="visibility: hidden;">Précédent</button>
                <button type="button" id="next-btn" class="btn-primary">Suivant <i class="fa-solid fa-arrow-right"></i></button>
            </div>
        </form>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loader-content">
            <div class="ai-loader"></div>
            <h2>Génération en cours...</h2>
            <p>L'IA analyse votre demande et construit votre site.</p>
            
            <div class="loading-steps">
                <div class="loading-step active" id="load-step-1">
                    <i class="fa-solid fa-circle-notch fa-spin"></i> Analyse du prompt
                </div>
                <div class="loading-step" id="load-step-2">
                    <i class="fa-regular fa-circle"></i> Architecture de la base de données
                </div>
                <div class="loading-step" id="load-step-3">
                    <i class="fa-regular fa-circle"></i> Génération du code Frontend
                </div>
                <div class="loading-step" id="load-step-4">
                    <i class="fa-regular fa-circle"></i> Déploiement initial
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="script.js"></script>

    <!-- Wizard Logic -->
    <script type="module">
        import { supabase } from './supabaseClient.js';
        import { protectPrivatePage } from './auth-oauth.js';

        let currentStep = 1;
        const totalSteps = 5;
        let currentUser = null;
        
        // Données du formulaire
        const formData = {
            name: '',
            description: '',
            type: '',
            style: '',
            features: [],
            pages: ['page_home']
        };

        // URL du Webhook n8n (Placeholder)
        const N8N_WEBHOOK_URL = 'https://n8n.webforge.ai/webhook/generate-project'; 

        document.addEventListener('DOMContentLoaded', async () => {
            // 1. Protection de la page
            const session = await protectPrivatePage();
            if (!session) return;
            currentUser = session.user;

            // 2. Initialisation des boutons
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');

            prevBtn.addEventListener('click', () => changeStep(-1));
            nextBtn.addEventListener('click', () => {
                if (currentStep === totalSteps) {
                    submitWizard();
                } else {
                    changeStep(1);
                }
            });

            // Fonctions globales pour les onclick HTML
            window.selectOption = (category, value) => {
                // Mise à jour visuelle
                const cards = document.querySelectorAll(`#step-${currentStep} .selection-card`);
                cards.forEach(card => card.classList.remove('selected'));
                event.currentTarget.classList.add('selected');

                // Mise à jour données
                formData[category] = value;
                document.getElementById(`selected-${category}`).value = value;
            };

            window.toggleCheckbox = (element, value) => {
                element.classList.toggle('selected');
                const isSelected = element.classList.contains('selected');
                
                if (currentStep === 4) { // Features
                    if (isSelected) formData.features.push(value);
                    else formData.features = formData.features.filter(item => item !== value);
                } else if (currentStep === 5) { // Pages
                    if (value === 'page_home') {
                        element.classList.add('selected'); // Home obligatoire
                        return;
                    }
                    if (isSelected) formData.pages.push(value);
                    else formData.pages = formData.pages.filter(item => item !== value);
                }
            };
        });

        function changeStep(direction) {
            if (!validateStep(currentStep) && direction > 0) return;

            // Masquer l'étape actuelle
            document.getElementById(`step-${currentStep}`).classList.remove('active');
            
            // Mettre à jour l'étape
            currentStep += direction;
            
            // Afficher la nouvelle étape
            document.getElementById(`step-${currentStep}`).classList.add('active');

            // Mettre à jour UI
            updateUI();
        }

        function updateUI() {
            // Progress Bar
            const progress = ((currentStep - 1) / (totalSteps - 1)) * 100;
            document.getElementById('progress-fill').style.width = `${progress}%`;

            // Indicators
            document.querySelectorAll('.step-indicator').forEach(ind => {
                const step = parseInt(ind.dataset.step);
                ind.classList.remove('active', 'completed');
                if (step === currentStep) ind.classList.add('active');
                if (step < currentStep) ind.classList.add('completed');
            });

            // Buttons
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');

            prevBtn.style.visibility = currentStep === 1 ? 'hidden' : 'visible';
            
            if (currentStep === totalSteps) {
                nextBtn.innerHTML = 'Générer le site <i class="fa-solid fa-wand-magic-sparkles"></i>';
                nextBtn.classList.remove('btn-primary');
                nextBtn.classList.add('btn-accent'); // Style spécial pour l'action finale
            } else {
                nextBtn.innerHTML = 'Suivant <i class="fa-solid fa-arrow-right"></i>';
                nextBtn.classList.add('btn-primary');
                nextBtn.classList.remove('btn-accent');
            }
        }

        function validateStep(step) {
            if (step === 1) {
                const name = document.getElementById('project-name').value.trim();
                const desc = document.getElementById('project-desc').value.trim();
                if (!name || !desc) {
                    alert("Veuillez remplir tous les champs.");
                    return false;
                }
                formData.name = name;
                formData.description = desc;
            }
            if (step === 2) {
                if (!formData.type) {
                    alert("Veuillez sélectionner un type de site.");
                    return false;
                }
            }
            if (step === 3) {
                if (!formData.style) {
                    alert("Veuillez sélectionner un style.");
                    return false;
                }
            }
            return true;
        }

        async function submitWizard() {
            // Afficher l'overlay de chargement
            const overlay = document.getElementById('loading-overlay');
            overlay.style.display = 'flex';

            try {
                // 1. Créer l'entrée dans Supabase
                updateLoadingStep(1);
                
                const { data: project, error: dbError } = await supabase
                    .from('projects')
                    .insert([
                        {
                            user_id: currentUser.id,
                            name: formData.name,
                            description: formData.description,
                            status: 'pending',
                            config: formData // Stocke toute la config JSON
                        }
                    ])
                    .select()
                    .single();

                if (dbError) throw dbError;

                updateLoadingStep(2);

                // 2. Envoyer au Webhook n8n
                // Note: Dans un environnement de prod, ceci serait déclenché par un Trigger Supabase Database Webhook
                // Mais pour ce wizard, on peut aussi faire un fetch direct si l'architecture le demande.
                // Ici, on simule l'appel ou on le fait réellement.
                
                try {
                    const response = await fetch(N8N_WEBHOOK_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            projectId: project.id,
                            userId: currentUser.id,
                            config: formData
                        })
                    });
                    
                    // On ne bloque pas si le fetch échoue car le webhook DB peut prendre le relais
                    // ou n8n peut être asynchrone.
                } catch (apiError) {
                    console.warn("Erreur appel API n8n (peut-être géré par Trigger DB):", apiError);
                }

                updateLoadingStep(3);
                
                // Simulation d'attente pour l'UX (pour voir les étapes)
                await new Promise(r => setTimeout(r, 1500));
                
                updateLoadingStep(4);
                await new Promise(r => setTimeout(r, 1000));

                // 3. Redirection
                window.location.href = 'dashboard.html';

            } catch (err) {
                console.error("Erreur création projet:", err);
                alert("Une erreur est survenue lors de la création du projet. Veuillez réessayer.");
                overlay.style.display = 'none';
            }
        }

        function updateLoadingStep(stepIndex) {
            const steps = document.querySelectorAll('.loading-step');
            steps.forEach((el, index) => {
                if (index + 1 < stepIndex) {
                    el.classList.remove('active');
                    el.classList.add('completed');
                    el.querySelector('i').className = 'fa-solid fa-check';
                } else if (index + 1 === stepIndex) {
                    el.classList.add('active');
                    el.querySelector('i').className = 'fa-solid fa-circle-notch fa-spin';
                }
            });
        }
    </script>
</body>
</html>